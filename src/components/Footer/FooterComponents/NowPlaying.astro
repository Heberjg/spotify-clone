---
// components/NowPlaying.astro
import { getImage } from 'astro:assets';
import placeholderImage from "../../../assets/background.svg";

// Obtener la imagen inicial (placeholder)
const imageSrc = await getImage({src: placeholderImage});
---
  <!-- Contenedor para la canción -->
  <div id="current-song-display">
    <img
      src={imageSrc.src}
      alt="Portada de canción"
      width="50"  
      height="50"
      id="song-image"
    />
    <div class="song-info">
      <h3 id="song-title"></h3>
      <p id="song-artist"></p>
    </div>
  </div>

  <script>
    import { playerStore } from "../../../store/playerStore.mjs";
    
    // Función para actualizar la imagen
    async function updateSongImage(imageUrl) {
      try {
        const response = await fetch(imageUrl);
        if (!response.ok) throw new Error('Image not found');
        
        const songImage = document.getElementById('song-image') as HTMLImageElement;
        songImage.src = imageUrl;
      } catch (error) {
        console.error('Error loading image:', error);
        // Puedes establecer una imagen por defecto aquí si falla
      }
    }

    // Suscripción a cambios en el store
    const unsubscribe = playerStore.subscribe(async (state) => {
      const { currentSongData } = state;
      const songTitle = document.getElementById('song-title');
      const songArtist = document.getElementById('song-artist');

      if (currentSongData) {
        // Actualizar elementos con los datos de la canción
        if (currentSongData.image?.src) {
          await updateSongImage(currentSongData.image.src);
        }
        songTitle.textContent = currentSongData.name;
        songArtist.textContent = currentSongData.artist;
      }
    });

    // Limpieza al desmontar
    window.addEventListener('beforeunload', unsubscribe);
  </script>

<style>
  
  #current-song-display {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  #song-image {
    border-radius: 4px;
    width: 55px;
    height: auto;
  }
  
  .song-info {
    display: flex;
    flex-direction: column;
  }
  
  #song-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 500;
    text-wrap: nowrap;
    overflow: hidden;
  }
  
  #song-artist {
    margin: 0;
    font-size: 0.875rem;
    color: #888;
    overflow: hidden;
    text-wrap: nowrap
  }
  
  
</style>